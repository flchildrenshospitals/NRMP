<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NRMP Data</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css">


  <style>
  /* General Page Styling */
  body {
    font-family: 'Arial', sans-serif;
    margin: 20px;
    padding: 0;
    background-color: #f4f4f9;
    color: #333;
  }

  /* Custom noUiSlider styling */
  .noUi-target {
    background-color: #e0e0e0; /* Background track color */
    border-radius: 10px; /* Rounded corners */
  }

  .noUi-connect {
    background-color: #003366; /* Match table header blue */
    border-radius: 10px; /* Rounded corners for the filled range */
  }

  .noUi-handle {
    background-color: #003366; /* Handle color */
    border: 2px solid white; /* White border for better visibility */
    height: 18px; /* Adjust size */
    width: 18px;
    border-radius: 50%; /* Rounded handle */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Subtle shadow */
  }

  .noUi-handle:hover {
    background-color: #00509e; /* Slightly lighter blue on hover */
  }

  .noUi-tooltip {
    background-color: #003366; /* Tooltip background */
    color: white; /* Tooltip text */
    font-size: 14px; /* Adjust font size */
    border-radius: 5px;
    padding: 5px 10px;
  }

  /* Wrapper for checkboxes and tables */
div[style*="display: flex"] {
  gap: 10px; /* Reduce space between checkboxes and tables */
  align-items: flex-start;
}

/* Specialty Checkboxes Styling */
#specialty-checkboxes {
  text-align: left;
  margin-right: 10px; /* Reduce space between checkboxes and tables */
  display: block; /* Ensure checkboxes are stacked vertically */
  border: 1px solid #ddd;
  background-color: #f9f9f9;
  padding: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#specialty-checkboxes label {
  display: block; /* Stack each checkbox vertically */
  margin-bottom: 5px; /* Add spacing between checkboxes */
}

  h1, h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
    font-weight: 700;
  }

  h1 {
    font-size: 28px;
    color: #2c3e50;
  }

  h2 {
    font-size: 22px;
    color: #003366;
  }

  table {
    width: auto; /* Auto-resize based on content */
    max-width: 80%; /* Limit the maximum width */
    margin: 20px auto; /* Center the table */
    border-collapse: collapse;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    table-layout: auto; /* Allow column sizes to adjust based on content */
  }

  /* Table Headers */
  th {
    background-color: #003366;
    color: white;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 16px;
    padding: 12px; /* Reduced padding */
    letter-spacing: 0.5px;
  }

  /* Table Rows */
  td {
    padding: 10px; /* Reduced padding */
    text-align: left;
    border-bottom: 1px solid #ddd;
    font-size: 15px;
    color: #555;
  }

  td:last-child {
    text-align: center; /* Center align Match % column */
    font-weight: bold;
  }

  /* Row Alternation */
  tr:nth-child(even) {
    background-color: #f5f5f5;
  }

  tr:nth-child(odd) {
    background-color: #ffffff;
  }

  tr:hover {
    background-color: #f1f1f1;
    transform: scale(1.01);
    transition: all 0.2s ease-in-out;
  }

  /* Total Row Styling */
  .total-row {
    background-color: #d9edf7; /* Highlight for Total Row */
    font-weight: bold;
    text-transform: uppercase;
  }

  .total-row td {
    font-size: 16px;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    table {
      width: 100%; /* Allow table to stretch fully on small screens */
    }

    th, td {
      font-size: 13px;
      padding: 8px;
    }

    h1 {
      font-size: 22px;
    }

    h2 {
      font-size: 18px;
    }
  }
</style>

</head>
<body>
  <h1>NRMP Data Viewer</h1>
  <div style="text-align: center; margin-bottom: 20px;">
  <div id="year-slider" style="margin: 20px auto; width: 80%;"></div>
  <label for="specialty-filter" style="margin-left: 20px;">Specialty: </label>
</div>
  <div style="display: flex; align-items: flex-start;">
  <div id="specialty-checkboxes"></div>
  <div style="flex-grow: 1; margin-left: 10px;"> <!-- Adjust margin-left -->
    <div id="content-header" style="text-align: center; font-size: 18px; margin-bottom: 20px;"></div>
    <div id="content"></div>
  </div>
</div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const csvUrl = "https://raw.githubusercontent.com/flchildrenshospitals/NRMP/refs/heads/main/NRMP_2020_2024_Main.csv";
    let yearRange = [2020, 2024]; // Default Year Range
    let selectedSpecialties = ["ALL"]; // Default: All specialties

    fetch(csvUrl)
      .then(response => response.text())
      .then(data => {
        const rows = data.split("\n").map(row => row.split(","));
        const headers = rows.shift().map(header => header.trim());

        // Extract years dynamically from headers
        const quotaYearColumns = headers.filter(header => header.match(/^\d{4} Quota$/));
        const matchedYearColumns = headers.filter(header => header.match(/^\d{4} Matched$/));
        const years = quotaYearColumns.map(col => parseInt(col.split(" ")[0], 10)); // Extract year as a number

        // Find other column indexes
        const sponsorIndex = headers.indexOf("Sponsoring Institution Cleaned");
        const snhafIndex = headers.indexOf("SNHAF");
        const specialtyIndex = headers.indexOf("Specialty Cleaned");

        if (
          sponsorIndex === -1 ||
          snhafIndex === -1 ||
          specialtyIndex === -1 ||
          quotaYearColumns.length === 0 ||
          matchedYearColumns.length === 0
        ) {
          console.error("Missing required columns. Please check your CSV file.");
          return;
        }

        // Create Year Range Slider
        const yearSlider = document.getElementById("year-slider");
        noUiSlider.create(yearSlider, {
          start: [Math.min(...years), Math.max(...years)],
          connect: true,
          range: {
            min: Math.min(...years),
            max: Math.max(...years),
          },
          step: 1,
          tooltips: true,
          format: {
            to: value => Math.round(value),
            from: value => Math.round(value),
          },
        });

        // Update Year Range and Trigger Table Update
        yearSlider.noUiSlider.on("update", function (values) {
          yearRange = values.map(v => parseInt(v, 10));
          updateTables();
        });

        // Populate Specialty Checkboxes
        const uniqueSpecialties = [...new Set(rows.map(row => row[specialtyIndex]?.trim()).filter(Boolean))].sort();
        const specialtyCheckboxContainer = document.getElementById("specialty-checkboxes");
        specialtyCheckboxContainer.innerHTML = `
          <label><input type="checkbox" value="ALL" checked> ALL</label>
        `;
        uniqueSpecialties.forEach(specialty => {
          const checkbox = document.createElement("label");
          checkbox.innerHTML = `<input type="checkbox" value="${specialty}"> ${specialty}`;
          specialtyCheckboxContainer.appendChild(checkbox);
        });

        // Handle Specialty Selection Changes
        specialtyCheckboxContainer.addEventListener("change", function () {
  const checkboxes = Array.from(specialtyCheckboxContainer.querySelectorAll("input[type='checkbox']"));
  
  // Determine selected specialties
  specialtyCheckboxContainer.addEventListener("change", function () {
  const checkboxes = Array.from(specialtyCheckboxContainer.querySelectorAll("input[type='checkbox']"));

  // Determine selected specialties
  selectedSpecialties = checkboxes
    .filter(checkbox => checkbox.checked)
    .map(checkbox => checkbox.value);

  if (selectedSpecialties.includes("ALL")) {
    // If "ALL" is checked, deselect all other checkboxes
    checkboxes.forEach(checkbox => {
      if (checkbox.value !== "ALL") checkbox.checked = false;
    });
    selectedSpecialties = ["ALL"]; // Reset selectedSpecialties to only "ALL"
  } else {
    // If any specific checkbox is checked, uncheck "ALL"
    const allCheckbox = checkboxes.find(checkbox => checkbox.value === "ALL");
    if (allCheckbox) allCheckbox.checked = false;
  }

  updateTables(); // Call table update function
});

        // Update Tables Based on Filters
        function updateTables() {
          const filteredRows = rows.filter(row => {
            // Check year range
            const yearMatch = years.some(year => {
              const inRange = year >= yearRange[0] && year <= yearRange[1];
              const quotaColumn = headers.indexOf(`${year} Quota`);
              return inRange && parseInt(row[quotaColumn]?.trim() || 0, 10) > 0;
            });

            // Check specialty filter
            const specialtyMatch =
              selectedSpecialties.includes("ALL") || selectedSpecialties.includes(row[specialtyIndex]?.trim());

            return yearMatch && specialtyMatch;
          });

          const snhafAggregates = {};
          const notAggregates = {};

          filteredRows.forEach(row => {
            const sponsor = row[sponsorIndex]?.trim();
            const snhaf = row[snhafIndex]?.trim();
            if (sponsor && snhaf) {
              const targetAggregates = snhaf === "SNHAF" ? snhafAggregates : notAggregates;

              if (!targetAggregates[sponsor]) {
                targetAggregates[sponsor] = { totalQuota: 0, totalMatched: 0 };
              }

              years.forEach(year => {
                if (year >= yearRange[0] && year <= yearRange[1]) {
                  const quotaColumn = headers.indexOf(`${year} Quota`);
                  const matchedColumn = headers.indexOf(`${year} Matched`);
                  targetAggregates[sponsor].totalQuota += parseInt(row[quotaColumn]?.trim() || 0, 10);
                  targetAggregates[sponsor].totalMatched += parseInt(row[matchedColumn]?.trim() || 0, 10);
                }
              });
            }
          });

          const contentDiv = document.getElementById("content");
          contentDiv.innerHTML = ""; // Clear previous tables

          contentDiv.appendChild(createTable(snhafAggregates, "SNHAF Sponsoring Institutions", "table1"));
          contentDiv.appendChild(createTable(notAggregates, "Non-SNHAF Sponsoring Institutions", "table2"));
        }

        // Function to create a table
        function createTable(aggregates, title, className) {
          const section = document.createElement("div");
          const titleElement = document.createElement("h2");
          titleElement.textContent = title;
          section.appendChild(titleElement);

          const table = document.createElement("table");
          table.classList.add(className);
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          // Add headers
          const headerRow = document.createElement("tr");
          ["Sponsoring Institution", "Total Quota", "Total Matched", "Match %"].forEach(header => {
            const th = document.createElement("th");
            th.textContent = header;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          // Sort aggregates by Match % and then Total Matched
          const sortedData = Object.keys(aggregates)
            .map(sponsor => {
              const sponsorData = aggregates[sponsor];
              const matchPercent =
                sponsorData.totalQuota > 0
                  ? (sponsorData.totalMatched / sponsorData.totalQuota) * 100
                  : 0;
              return {
                sponsor,
                totalQuota: sponsorData.totalQuota,
                totalMatched: sponsorData.totalMatched,
                matchPercent,
              };
            })
            .sort((a, b) => {
              if (b.matchPercent !== a.matchPercent) {
                return b.matchPercent - a.matchPercent;
              }
              return b.totalMatched - a.totalMatched;
            });

          // Add rows
          let totalQuota = 0;
          let totalMatched = 0;

          sortedData.forEach(data => {
            const tr = document.createElement("tr");
            const sponsorCell = document.createElement("td");
            const quotaCell = document.createElement("td");
            const matchedCell = document.createElement("td");
            const matchPercentCell = document.createElement("td");

            sponsorCell.textContent = data.sponsor;
            quotaCell.textContent = data.totalQuota.toLocaleString();
            matchedCell.textContent = data.totalMatched.toLocaleString();
            matchPercentCell.textContent = data.matchPercent.toFixed(2) + "%";

            tr.appendChild(sponsorCell);
            tr.appendChild(quotaCell);
            tr.appendChild(matchedCell);
            tr.appendChild(matchPercentCell);
            tbody.appendChild(tr);

            totalQuota += data.totalQuota;
            totalMatched += data.totalMatched;
          });

          // Add total row
          const totalRow = document.createElement("tr");
          totalRow.classList.add("total-row");
          totalRow.innerHTML = `
            <td>Total</td>
            <td>${totalQuota.toLocaleString()}</td>
            <td>${totalMatched.toLocaleString()}</td>
            <td>${(totalQuota > 0 ? (totalMatched / totalQuota) * 100 : 0).toFixed(2)}%</td>
          `;
          tbody.appendChild(totalRow);

          table.appendChild(thead);
          table.appendChild(tbody);
          section.appendChild(table);
          return section;
        }

        // Initialize Tables
        updateTables();
      })
      .catch(error => console.error("Error loading CSV:", error));
  });
</script>

</body>
</html>
