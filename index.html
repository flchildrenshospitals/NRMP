<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NRMP Data</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css">


  <style>
  /* General Styling */
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f9;
  color: #333;
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 20px auto;
  padding: 0 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Header Styling */
h1 {
  text-align: center;
  font-size: 28px;
  color: #2c3e50;
  margin-bottom: 20px;
}

/* Slider Section */
.slider-section {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 10px 0;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#year-slider {
  width: 90%;
}

.noUi-connect {
  background-color: #003366; /* Updated to preferred blue */
}

/* Main Layout */
.main-layout {
  display: flex;
  gap: 20px;
}

/* Specialty Checkboxes */
#specialty-checkboxes {
  flex: none; /* Prevent flexbox from stretching this container */
  max-height: fit-content; /* Ensure the height is just enough to fit the content */
  height: auto;
  border: 1px solid #ddd;
  background-color: #fff;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  max-width: 350px; /* Increased width for labels */
}

#specialty-checkboxes label {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  white-space: nowrap; /* Prevent wrapping */
}

#specialty-checkboxes input[type="checkbox"] {
  margin-right: 8px;
}

/* Content Section */
main#content {
  flex: 2;
  padding: 15px;
  border-radius: 8px;
  background-color: #fff;
  border: 1px solid #ddd;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Table Styling */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  border: 1px solid #ddd;
}

.table-container {
  border: 1px solid #ddd;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  padding: 20px;
  margin-bottom: 20px; /* Add space between table boxes */
}

.table-container h2 {
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 20px;
  color: #003366;
  text-align: left;
}

th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

th {
  background-color: #003366;
  color: #fff;
  text-transform: uppercase;
}

tr:nth-child(even) {
  background-color: #f9f9f9;
}

tr:hover {
  background-color: #f1f1f1;
  transition: background-color 0.3s ease;
}

/* Total Row */
.total-row {
  background-color: rgba(218, 233, 248, 0.5) !important; /* Updated to preferred color */
  font-weight: bold;
}

.total-row td {
  font-size: 16px;
}

/* Responsive Layout */
@media (max-width: 768px) {
  .main-layout {
    flex-direction: column;
  }

  #specialty-checkboxes {
    max-width: 100%;
  }

  #content {
    margin-top: 20px;
  }
}

</style>

</head>
<body>
  <div class="container">
  <h1>NRMP Data Viewer</h1>

  <!-- Slider Section -->
  <div class="slider-section">
    <div id="year-slider"></div>
  </div>

  <!-- Main Layout -->
  <div class="main-layout">
    <!-- Specialty Checkboxes -->
    <aside id="specialty-checkboxes"></aside>

    <!-- Content Section -->
    <main id="content"></main>
  </div>
</div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const csvUrl = "https://raw.githubusercontent.com/flchildrenshospitals/NRMP/refs/heads/main/NRMP_2020_2024_Main.csv";
    let yearRange = [2020, 2024]; // Default Year Range
    let selectedSpecialties = ["ALL"]; // Default: All specialties

    fetch(csvUrl)
      .then(response => response.text())
      .then(data => {
        const rows = data.split("\n").map(row => row.split(","));
        const headers = rows.shift().map(header => header.trim());

        // Extract years dynamically from headers
        const quotaYearColumns = headers.filter(header => header.match(/^\d{4} Quota$/));
        const matchedYearColumns = headers.filter(header => header.match(/^\d{4} Matched$/));
        const years = quotaYearColumns.map(col => parseInt(col.split(" ")[0], 10)); // Extract year as a number

        // Find other column indexes
        const sponsorIndex = headers.indexOf("Sponsoring Institution Cleaned");
        const snhafIndex = headers.indexOf("SNHAF");
        const specialtyIndex = headers.indexOf("Specialty Cleaned");

        if (
          sponsorIndex === -1 ||
          snhafIndex === -1 ||
          specialtyIndex === -1 ||
          quotaYearColumns.length === 0 ||
          matchedYearColumns.length === 0
        ) {
          console.error("Missing required columns. Please check your CSV file.");
          return;
        }

        // Create Year Range Slider
        const yearSlider = document.getElementById("year-slider");
        noUiSlider.create(yearSlider, {
          start: [Math.min(...years), Math.max(...years)],
          connect: true,
          range: {
            min: Math.min(...years),
            max: Math.max(...years),
          },
          step: 1,
          tooltips: true,
          format: {
            to: value => Math.round(value),
            from: value => Math.round(value),
          },
        });

        // Update Year Range and Trigger Table Update
        yearSlider.noUiSlider.on("update", function (values) {
          yearRange = values.map(v => parseInt(v, 10));
          updateTables();
        });

        // Populate Specialty Checkboxes
        const uniqueSpecialties = [...new Set(rows.map(row => row[specialtyIndex]?.trim()).filter(Boolean))].sort();
        const specialtyCheckboxContainer = document.getElementById("specialty-checkboxes");
        specialtyCheckboxContainer.innerHTML = `
          <label><input type="checkbox" value="ALL" checked> ALL</label>
        `;
        uniqueSpecialties.forEach(specialty => {
          const checkbox = document.createElement("label");
          checkbox.innerHTML = `<input type="checkbox" value="${specialty}"> ${specialty}`;
          specialtyCheckboxContainer.appendChild(checkbox);
        });

        // Handle Specialty Selection Changes
        specialtyCheckboxContainer.addEventListener("change", function (event) {
    const checkboxes = Array.from(specialtyCheckboxContainer.querySelectorAll("input[type='checkbox']"));
    const allCheckbox = checkboxes.find(checkbox => checkbox.value === "ALL");

    if (event.target.value === "ALL") {
        // If "ALL" is checked, deselect all others
        if (event.target.checked) {
            checkboxes.forEach(checkbox => {
                if (checkbox.value !== "ALL") checkbox.checked = false;
            });
            selectedSpecialties = ["ALL"];
        } else {
            selectedSpecialties = [];
        }
    } else {
        // If any specific checkbox is checked, uncheck "ALL"
        if (event.target.checked) {
            allCheckbox.checked = false;
        }

        // Update selected specialties
        selectedSpecialties = checkboxes
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);

        // Ensure "ALL" is deselected if other boxes are selected
        if (selectedSpecialties.includes("ALL")) {
            selectedSpecialties = selectedSpecialties.filter(value => value !== "ALL");
        }
    }

    updateTables(); // Update table based on the new selection
});

        // Update Tables Based on Filters
        function updateTables() {
  const filteredRows = rows.filter(row => {
    // Check year range
    const yearMatch = years.some(year => {
      const inRange = year >= yearRange[0] && year <= yearRange[1];
      const quotaColumn = headers.indexOf(`${year} Quota`);
      return inRange && parseInt(row[quotaColumn]?.trim() || 0, 10) > 0;
    });

    // Check specialty filter
    const specialtyMatch =
      selectedSpecialties.includes("ALL") || selectedSpecialties.includes(row[specialtyIndex]?.trim());

    return yearMatch && specialtyMatch;
  });

  const snhafAggregates = {};
  const notAggregates = {};

  filteredRows.forEach(row => {
    const sponsor = row[sponsorIndex]?.trim();
    const snhaf = row[snhafIndex]?.trim();
    if (sponsor && snhaf) {
      const targetAggregates = snhaf === "SNHAF" ? snhafAggregates : notAggregates;

      if (!targetAggregates[sponsor]) {
        targetAggregates[sponsor] = { totalQuota: 0, totalMatched: 0 };
      }

      years.forEach(year => {
        if (year >= yearRange[0] && year <= yearRange[1]) {
          const quotaColumn = headers.indexOf(`${year} Quota`);
          const matchedColumn = headers.indexOf(`${year} Matched`);
          targetAggregates[sponsor].totalQuota += parseInt(row[quotaColumn]?.trim() || 0, 10);
          targetAggregates[sponsor].totalMatched += parseInt(row[matchedColumn]?.trim() || 0, 10);
        }
      });
    }
  });

  const contentDiv = document.getElementById("content");
  contentDiv.innerHTML = ""; // Clear previous content

  // Create container for SNHAF table
  const snhafContainer = document.createElement("div");
  snhafContainer.classList.add("table-container");
  snhafContainer.innerHTML = `<h2>SNHAF Sponsoring Institutions</h2>`;
  snhafContainer.appendChild(createTable(snhafAggregates, "SNHAF Sponsoring Institutions", "table1"));

  // Create container for Non-SNHAF table
  const nonSnhafContainer = document.createElement("div");
  nonSnhafContainer.classList.add("table-container");
  nonSnhafContainer.innerHTML = `<h2>Non-SNHAF Sponsoring Institutions</h2>`;
  nonSnhafContainer.appendChild(createTable(notAggregates, "Non-SNHAF Sponsoring Institutions", "table2"));

  // Append both containers to the content div
  contentDiv.appendChild(snhafContainer);
  contentDiv.appendChild(nonSnhafContainer);
}

        // Function to create a table
        function createTable(aggregates, title, className) {
          const section = document.createElement("div");
          const titleElement = document.createElement("h2");
          titleElement.textContent = title;
          section.appendChild(titleElement);

          const table = document.createElement("table");
          table.classList.add(className);
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          // Add headers
          const headerRow = document.createElement("tr");
          ["Sponsoring Institution", "Total Quota", "Total Matched", "Match %"].forEach(header => {
            const th = document.createElement("th");
            th.textContent = header;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          // Sort aggregates by Match % and then Total Matched
          const sortedData = Object.keys(aggregates)
            .map(sponsor => {
              const sponsorData = aggregates[sponsor];
              const matchPercent =
                sponsorData.totalQuota > 0
                  ? (sponsorData.totalMatched / sponsorData.totalQuota) * 100
                  : 0;
              return {
                sponsor,
                totalQuota: sponsorData.totalQuota,
                totalMatched: sponsorData.totalMatched,
                matchPercent,
              };
            })
            .sort((a, b) => {
              if (b.matchPercent !== a.matchPercent) {
                return b.matchPercent - a.matchPercent;
              }
              return b.totalMatched - a.totalMatched;
            });

          // Add rows
          let totalQuota = 0;
          let totalMatched = 0;

          sortedData.forEach(data => {
            const tr = document.createElement("tr");
            const sponsorCell = document.createElement("td");
            const quotaCell = document.createElement("td");
            const matchedCell = document.createElement("td");
            const matchPercentCell = document.createElement("td");

            sponsorCell.textContent = data.sponsor;
            quotaCell.textContent = data.totalQuota.toLocaleString();
            matchedCell.textContent = data.totalMatched.toLocaleString();
            matchPercentCell.textContent = data.matchPercent.toFixed(2) + "%";

            tr.appendChild(sponsorCell);
            tr.appendChild(quotaCell);
            tr.appendChild(matchedCell);
            tr.appendChild(matchPercentCell);
            tbody.appendChild(tr);

            totalQuota += data.totalQuota;
            totalMatched += data.totalMatched;
          });

          // Add total row
          const totalRow = document.createElement("tr");
          totalRow.classList.add("total-row");
          totalRow.innerHTML = `
            <td>Total</td>
            <td>${totalQuota.toLocaleString()}</td>
            <td>${totalMatched.toLocaleString()}</td>
            <td>${(totalQuota > 0 ? (totalMatched / totalQuota) * 100 : 0).toFixed(2)}%</td>
          `;
          tbody.appendChild(totalRow);

          table.appendChild(thead);
          table.appendChild(tbody);
          section.appendChild(table);
          return section;
        }

        // Initialize Tables
        updateTables();
      })
      .catch(error => console.error("Error loading CSV:", error));
  });
</script>

</body>
</html>
