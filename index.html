<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NRMP Data</title>

  <style>
  /* General Page Styling */
  body {
    font-family: 'Arial', sans-serif;
    margin: 20px;
    padding: 0;
    background-color: #f4f4f9;
    color: #333;
  }

  h1, h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
    font-weight: 700;
  }

  h1 {
    font-size: 28px;
    color: #2c3e50;
  }

  h2 {
    font-size: 22px;
    color: #003366;
  }

  table {
    width: auto; /* Auto-resize based on content */
    max-width: 80%; /* Limit the maximum width */
    margin: 20px auto; /* Center the table */
    border-collapse: collapse;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    table-layout: auto; /* Allow column sizes to adjust based on content */
  }

  /* Table Headers */
  th {
    background-color: #003366;
    color: white;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 16px;
    padding: 12px; /* Reduced padding */
    letter-spacing: 0.5px;
  }

  /* Table Rows */
  td {
    padding: 10px; /* Reduced padding */
    text-align: left;
    border-bottom: 1px solid #ddd;
    font-size: 15px;
    color: #555;
  }

  td:last-child {
    text-align: center; /* Center align Match % column */
    font-weight: bold;
  }

  /* Row Alternation */
  tr:nth-child(even) {
    background-color: #f5f5f5;
  }

  tr:nth-child(odd) {
    background-color: #ffffff;
  }

  tr:hover {
    background-color: #f1f1f1;
    transform: scale(1.01);
    transition: all 0.2s ease-in-out;
  }

  /* Total Row Styling */
  .total-row {
    background-color: #d9edf7; /* Highlight for Total Row */
    font-weight: bold;
    text-transform: uppercase;
  }

  .total-row td {
    font-size: 16px;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    table {
      width: 100%; /* Allow table to stretch fully on small screens */
    }

    th, td {
      font-size: 13px;
      padding: 8px;
    }

    h1 {
      font-size: 22px;
    }

    h2 {
      font-size: 18px;
    }
  }
</style>

</head>
<body>
  <h1>NRMP Data Viewer</h1>
  <div style="text-align: center; margin-bottom: 20px;">
  <label for="year-filter">Year: </label>
  <input id="year-filter" type="range" min="2020" max="2024" value="2024" step="1">
  <span id="year-value">ALL</span>

  <label for="specialty-filter" style="margin-left: 20px;">Specialty: </label>
  <select id="specialty-filter">
    <option value="ALL">ALL</option>
  </select>
</div>

  <div id="content"></div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const csvUrl = "https://raw.githubusercontent.com/flchildrenshospitals/NRMP/refs/heads/main/NRMP_2020_2024_Main.csv";
    let yearFilter = "ALL"; // Default Year (ALL)
    let specialtyFilter = "ALL"; // Default Specialty (ALL)

    // Function to filter rows based on the year and specialty
    function filterRows(rows, yearColumnIndex, specialtyColumnIndex) {
      return rows.filter(row => {
        const yearMatch = yearFilter === "ALL" || row[yearColumnIndex]?.trim() === yearFilter;
        const specialtyMatch = specialtyFilter === "ALL" || row[specialtyColumnIndex]?.trim() === specialtyFilter;
        return yearMatch && specialtyMatch;
      });
    }

    fetch(csvUrl)
      .then(response => response.text())
      .then(data => {
        const rows = data.split("\n").map(row => row.split(","));
        const headers = rows.shift().map(header => header.trim());

        // Find column indexes
        const sponsorIndex = headers.indexOf("Sponsoring Institution Cleaned");
        const snhafIndex = headers.indexOf("SNHAF");
        const specialtyIndex = headers.indexOf("Specialty Cleaned");
        const yearColumnIndex = headers.indexOf("Year");
        const quotaIndexes = [
          headers.indexOf("2024 Quota"),
          headers.indexOf("2023 Quota"),
          headers.indexOf("2022 Quota"),
          headers.indexOf("2021 Quota"),
          headers.indexOf("2020 Quota"),
        ];
        const matchedIndexes = [
          headers.indexOf("2024 Matched"),
          headers.indexOf("2023 Matched"),
          headers.indexOf("2022 Matched"),
          headers.indexOf("2021 Matched"),
          headers.indexOf("2020 Matched"),
        ];

        if (
          sponsorIndex === -1 ||
          snhafIndex === -1 ||
          specialtyIndex === -1 ||
          yearColumnIndex === -1 ||
          quotaIndexes.includes(-1) ||
          matchedIndexes.includes(-1)
        ) {
          console.error("Missing required columns");
          return;
        }

        // Populate Specialty Dropdown
        const uniqueSpecialties = [...new Set(rows.map(row => row[specialtyIndex]?.trim()).filter(Boolean))].sort();
        const specialtyDropdown = document.getElementById("specialty-filter");
        specialtyDropdown.innerHTML = `<option value="ALL">ALL</option>`;
        uniqueSpecialties.forEach(specialty => {
          const option = document.createElement("option");
          option.value = specialty;
          option.textContent = specialty;
          specialtyDropdown.appendChild(option);
        });

        // Update Tables Based on Filters
        function updateTables() {
          const filteredRows = filterRows(rows, yearColumnIndex, specialtyIndex);

          const snhafAggregates = {};
          const notAggregates = {};

          filteredRows.forEach(row => {
            const sponsor = row[sponsorIndex]?.trim();
            const snhaf = row[snhafIndex]?.trim();
            if (sponsor && snhaf) {
              const targetAggregates = snhaf === "SNHAF" ? snhafAggregates : notAggregates;

              if (!targetAggregates[sponsor]) {
                targetAggregates[sponsor] = { totalQuota: 0, totalMatched: 0 };
              }

              quotaIndexes.forEach(index => {
                targetAggregates[sponsor].totalQuota += parseInt(row[index]?.trim() || 0, 10);
              });

              matchedIndexes.forEach(index => {
                targetAggregates[sponsor].totalMatched += parseInt(row[index]?.trim() || 0, 10);
              });
            }
          });

          const contentDiv = document.getElementById("content");
          contentDiv.innerHTML = ""; // Clear previous tables

          contentDiv.appendChild(createTable(snhafAggregates, "SNHAF Sponsoring Institutions", "table1"));
          contentDiv.appendChild(createTable(notAggregates, "Non-SNHAF Sponsoring Institutions", "table2"));
        }

        // Function to create a table
        function createTable(aggregates, title, className) {
          const section = document.createElement("div");
          const titleElement = document.createElement("h2");
          titleElement.textContent = title;
          section.appendChild(titleElement);

          const table = document.createElement("table");
          table.classList.add(className);
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          // Add headers
          const headerRow = document.createElement("tr");
          ["Sponsoring Institution", "Total Quota", "Total Matched", "Match %"].forEach(header => {
            const th = document.createElement("th");
            th.textContent = header;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          // Sort aggregates by Match % and then Total Matched
          const sortedData = Object.keys(aggregates)
            .map(sponsor => {
              const sponsorData = aggregates[sponsor];
              const matchPercent =
                sponsorData.totalQuota > 0
                  ? (sponsorData.totalMatched / sponsorData.totalQuota) * 100
                  : 0;
              return {
                sponsor,
                totalQuota: sponsorData.totalQuota,
                totalMatched: sponsorData.totalMatched,
                matchPercent,
              };
            })
            .sort((a, b) => {
              if (b.matchPercent !== a.matchPercent) {
                return b.matchPercent - a.matchPercent;
              }
              return b.totalMatched - a.totalMatched;
            });

          // Add rows
          let totalQuota = 0;
          let totalMatched = 0;

          sortedData.forEach(data => {
            const tr = document.createElement("tr");
            const sponsorCell = document.createElement("td");
            const quotaCell = document.createElement("td");
            const matchedCell = document.createElement("td");
            const matchPercentCell = document.createElement("td");

            sponsorCell.textContent = data.sponsor;
            quotaCell.textContent = data.totalQuota.toLocaleString();
            matchedCell.textContent = data.totalMatched.toLocaleString();
            matchPercentCell.textContent = data.matchPercent.toFixed(2) + "%";

            tr.appendChild(sponsorCell);
            tr.appendChild(quotaCell);
            tr.appendChild(matchedCell);
            tr.appendChild(matchPercentCell);
            tbody.appendChild(tr);

            totalQuota += data.totalQuota;
            totalMatched += data.totalMatched;
          });

          // Add total row
          const totalRow = document.createElement("tr");
          totalRow.classList.add("total-row");
          totalRow.innerHTML = `
            <td>Total</td>
            <td>${totalQuota.toLocaleString()}</td>
            <td>${totalMatched.toLocaleString()}</td>
            <td>${(totalQuota > 0 ? (totalMatched / totalQuota) * 100 : 0).toFixed(2)}%</td>
          `;
          tbody.appendChild(totalRow);

          table.appendChild(thead);
          table.appendChild(tbody);
          section.appendChild(table);
          return section;
        }

        // Event Listeners for Filters
        document.getElementById("year-filter").addEventListener("input", function (event) {
          yearFilter = event.target.value === "ALL" ? "ALL" : event.target.value;
          updateTables();
        });

        document.getElementById("specialty-filter").addEventListener("change", function (event) {
          specialtyFilter = event.target.value;
          updateTables();
        });

        // Initialize Tables
        updateTables();
      })
      .catch(error => console.error("Error loading CSV:", error));
  });
</script>

</body>
</html>
